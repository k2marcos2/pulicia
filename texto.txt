function doPost(e) {
  try {
    const SPREADSHEET_ID = "1rF19ZUm0FymIjWRU5Qhzn_LkGmJT1i9akgyskPEsrr4";
    const SHEET_NAME = "RESPOSTAS";
    const DRIVE_FOLDER_ID = "1hpZIm3OedEs82yeLN6IG-z3RUu9QMv3w";

    const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName(SHEET_NAME);
    const folder = DriveApp.getFolderById(DRIVE_FOLDER_ID);
    const params = e.parameter;

    Logger.log(JSON.stringify(params));

    let midiaLinks = [];
    for (let key in params) {
      if (key.startsWith("MidiaBase64_")) {
        const base64 = params[key].split(',')[1];
        const blob = Utilities.newBlob(Utilities.base64Decode(base64), "image/jpeg", `foto_${Date.now()}.jpg`);
        const file = folder.createFile(blob);
        file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
        midiaLinks.push(getDirectDownloadLink(file));
      }
    }

    let assinaturaURL = "Sem assinatura";
    if (params.AssinaturaBase64) {
      const base64Data = params.AssinaturaBase64.split(',')[1];
      const blob = Utilities.newBlob(Utilities.base64Decode(base64Data), "image/png", `assinatura_${params.Motorista}_${Date.now()}.png`);
      const file = folder.createFile(blob);
      file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
      assinaturaURL = getDirectDownloadLink(file);
    }

    const pdfURL = gerarChecklistPDF(params, assinaturaURL, midiaLinks);

    const novaLinha = [
      new Date(),
      params.Motorista || "",
      params.PostoGraduacao || "",
      params.RG || "",
      params.DataCautela || "",
      params.HoraCautela || "",
      params.ValidadeCNH || "",
      params.CategoriaCNH || "",
      params.Veiculo || "",
      params.Prefixo || "",
      params.Placa || "",
      params.KmAtual || "",
      params.KmProxRevisao || "",
      params.NivelAgua || "",
      params.NivelOleo || "",
      params.NivelCombustivel || "",
      params.Pneus || "",
      params.GiroflexSirene || "",
      params.LampadasQueimadas || "",
      params.Parabrisa || "",
      params.Radio || "",
      params.EquipamentosObrigatorios || "",
      params.QtdCones || "",
      params.OutrosProblemas || "",
      midiaLinks.join(" | "),
      assinaturaURL,
      pdfURL
    ];

    sheet.appendRow(novaLinha);

    return ContentService.createTextOutput(JSON.stringify({
      status: "success",
      message: "Checklist enviado e PDF gerado!",
      pdf: pdfURL
    })).setMimeType(ContentService.MimeType.JSON);

  } catch (err) {
    return ContentService.createTextOutput(JSON.stringify({
      status: "error",
      message: err.toString()
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

function getDirectDownloadLink(file) {
  return "https://drive.google.com/uc?export=download&id=" + file.getId();
}


code do PDF.gs

function gerarChecklistPDF(data, assinaturaURL, midiaLinks) {
  const folderId = '1hpZIm3OedEs82yeLN6IG-z3RUu9QMv3w';
  const templateId = '1FoRErwkfgz1otLS1PGwRoFpAWC_qth3V2vNmDP9_ge4';

  const copy = DriveApp.getFileById(templateId).makeCopy(`Checklist - ${data.Motorista}`, DriveApp.getFolderById(folderId));
  const presentation = SlidesApp.openById(copy.getId());
  let slide = presentation.getSlides()[0];

  const margin = 30;
  const larguraCaixa = 540;
  const maxY = 750;
  let y = 30;

  function adicionarBloco(titulo, conteudo) {
    if (y + 40 > maxY) {
      slide = presentation.appendSlide(SlidesApp.PredefinedLayout.BLANK);
      y = 30;
    }
    const tituloShape = slide.insertTextBox(titulo, margin, y, larguraCaixa, 20);
    tituloShape.getText().getTextStyle().setBold(true).setFontSize(18);
    y += 25;

    const conteudoShape = slide.insertTextBox(conteudo, margin, y, larguraCaixa, 400);
    y += conteudoShape.getHeight() + 10;
  }

  // Bloco 1 — Título
  const tituloShape = slide.insertTextBox("CHECKLIST DE CAUTELA DE VIATURAS", margin, y, larguraCaixa, 30);
  tituloShape.getText().getTextStyle().setBold(true).setFontSize(22);
  y += 40;

  // Dados do motorista
  const dadosMotorista = `
Motorista: ${data.Motorista}
Posto/Graduação: ${data.PostoGraduacao}
RG: ${data.RG}
Data Cautela: ${data.DataCautela}
Hora: ${data.HoraCautela}
Validade CNH: ${data.ValidadeCNH}
Categoria CNH: ${data.CategoriaCNH}
Veículo: ${data.Veiculo}
Prefixo: ${data.Prefixo}
Placa: ${data.Placa}
Km Atual: ${data.KmAtual}
Km Próx. Revisão: ${data.KmProxRevisao}
`;
  adicionarBloco("DADOS DO MOTORISTA", dadosMotorista);

  // Checklist técnico
  const checklistTecnico = `
Nível de Água: ${data.NivelAgua}
Nível de Óleo: ${data.NivelOleo}
Combustível: ${data.NivelCombustivel}
Pneus: ${data.Pneus}
Giroflex/Sirene: ${data.GiroflexSirene}
Lâmpadas Queimadas: ${data.LampadasQueimadas}
Parabrisa: ${data.Parabrisa}
Rádio: ${data.Radio}
Equipamentos Obrigatórios: ${data.EquipamentosObrigatorios}
Qtd Cones: ${data.QtdCones}
Outros Problemas: ${data.OutrosProblemas}
`;
  adicionarBloco("CHECKLIST DE VERIFICAÇÃO", checklistTecnico);

  // Mídias (se tiver)
  if (midiaLinks.length > 0) {
    const midiasTexto = midiaLinks.join("\n");
    adicionarBloco("MÍDIAS", midiasTexto);
  }

  // Assinatura (se tiver)
  if (assinaturaURL && assinaturaURL !== "Sem assinatura") {
    if (y + 80 > maxY) {
      slide = presentation.appendSlide(SlidesApp.PredefinedLayout.BLANK);
      y = 30;
    }
    const tituloShape = slide.insertTextBox("ASSINATURA", margin, y, larguraCaixa, 20);
    tituloShape.getText().getTextStyle().setBold(true).setFontSize(18);
    y += 25;
    const blob = UrlFetchApp.fetch(assinaturaURL).getBlob();
    slide.insertImage(blob, margin, y, 200, 60);
    y += 70;
  }

  presentation.saveAndClose();

  const pdf = DriveApp.getFileById(presentation.getId()).getAs("application/pdf");
  const folder = DriveApp.getFolderById(folderId);
  const pdfFile = folder.createFile(pdf);
  pdfFile.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);

  return "https://drive.google.com/uc?export=download&id=" + pdfFile.getId();
}

